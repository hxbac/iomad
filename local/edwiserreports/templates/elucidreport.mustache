{{!
This file is part of Moodle - http://moodle.org/

Moodle is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Moodle is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

Edwiser RemUI
@package theme_remui
@copyright (c) 2020 WisdmLabs (https://wisdmlabs.com/)
@license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later

}}
{{!
@template theme_remui/activity_navigation

Display the activity navigation for all activities in a course

Context variables required for this template:

Example context (json):
{
}
}}
<div id="wdm-edwiserreports" class="row m-0 d-none" data-editing="{{ editing }}">
    {{# blocks }}
    <div class="{{{extraclasses}}} mb-5 edwiserReport-block {{# hiddenblock }} block-hidden {{/ hiddenblock}}">
        <div id="{{id}}" data-sesskey="{{sesskey}}" data-blockname="{{name}}">
            <div class="panel m-0">
                <div class="panel-header d-flex">
                    <div class="panel-title px-0 col-10">
                        <strong class="mb-1">
                            {{{name}}}
                            <a href="javascript:void(0)" data-title="{{info}}" class="small" data-toggle="tooltip"
                                data-trigger="hover" data-placement="bottom">
                                <i class="fa fa-question-circle"></i>
                            </a>
                        </strong>

                        <div class="block-filters">{{{ filters }}}</div>
                    </div>
                    {{# editopt }}
                    <div class="col-2 p-0">
                        {{> local_edwiserreports/blocksettingdropdown }}
                    </div>
                    {{/ editopt }}
                </div>
                <div class="panel-body p-0">
                    {{{ blockview }}}
                    <div class="loader w-full text-center">
                        {{# pix }} loader, local_edwiserreports{{/ pix }}
                    </div>
                    {{#iscustomblock}}
                    <table class="table customreportdata w-full"></table>
                    {{/iscustomblock}}
                </div>
                <div class="panel-footer row m-0">
                    {{# morelink }}
                    <div class="">
                        <a href="{{{.}}}" class="btn btn-primary btn-sm">{{#str}} more, local_edwiserreports
                            {{/str}}</a>
                    </div>
                    {{/ morelink }}
                    {{# hasdownloadlink }}
                    {{> local_edwiserreports/exportreports }}
                    {{/ hasdownloadlink }}
                </div>
            </div>
        </div>
    </div>
    {{#iscustomblock}}
    {{#js}}
    require([
    'jquery',
    'core/ajax',
    'local_edwiserreports/customreportsblock'
    ], function(
    $,
    ajax,
    customreportsblock
    ) {
    var tableId = '#{{{id}}} table.customreportdata'

    $(document).ready(function() {
    var getCustomReportsData = ajax.call([{
    methodname: 'local_edwiserreports_get_customreports_data',
    args: {
    params: JSON.stringify({{{params}}})
    }
    }]);

    getCustomReportsData[0].done(function(response) {
    if (response.success) {
    var data = JSON.parse(response.data);
    $(tableId).DataTable({
    columns: data.columns,
    data: data.reportsdata,
    bInfo: false,
    lengthChange: false,
    language: {
    searchPlaceholder: "{{#str}}searchreports, local_edwiserreports{{/str}}",
    emptyTable: "{{#str}}noresult, local_edwiserreports{{/str}}"
    },
    drawCallback: function() {
    $('.dataTables_paginate > .pagination').addClass('pagination-sm pull-right');
    $('.dataTables_filter').addClass('pagination-sm pull-right');
    }
    });
    }
    });
    });
    });
    {{/js}}
    {{/iscustomblock}}
    {{/ blocks }}
    {{# canmanagecustomreports }}
    <div class="col-12">
        <a href="{{customreportseditlink}}" class="btn btn-primary pull-right">
            <i class="icon fa fa-plus fa-fw " aria-hidden="true"></i>
            {{#str}} createcustomreports, local_edwiserreports {{/str}}
        </a>
    </div>
    {{/ canmanagecustomreports }}
</div>


<script>

    function fetchGetDataYear(domain, yearSelector) {
        fetch(domain + '/local/edwiserreports/lms_custom_api_get_year.php', {
            method: 'POST', // or 'PUT'
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify([]),
        })
            .then((response) => response.json())
            .then((dataRes) => {
                if (dataRes.message == 'success') {
                    let yearHTML = ''
                    let i = 0
                    dataRes.data.forEach(year => {
                        yearHTML += `<option value="${year.id}" ${i === 0 ? 'selected' : ''}">${year.name}</option>`
                        i++
                    })

                    if (i === 0) {
                        yearHTML = `<option value="0"}>Không có dữ liệu</option>`
                    }

                    yearSelector.innerHTML = yearHTML
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            })
    }

    function fetchDataSemester(domain, semesterSelector, yearId) {
        fetch(domain + '/local/edwiserreports/lms_custom_api_get_semester.php?yearId=' + yearId, {
            method: 'POST', // or 'PUT'
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify([]),
        })
            .then((response) => response.json())
            .then((dataRes) => {
                if (dataRes.message == 'success') {
                    let semesterHTML = ''
                    let i = 0
                    dataRes.data.forEach(semester => {
                        semesterHTML += `<option value="${semester.id}" ${i === 0 ? 'selected' : ''}>${semester.name}</option>`
                        i++
                    })

                    if (i === 0) {
                        semesterHTML = `<option value="0"}>Không có dữ liệu</option>`
                    }

                    semesterSelector.innerHTML = semesterHTML
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            })
    }

    function fetchDataSubjectManage(domain, subjectManageSelector, semesterId) {
        fetch(domain + '/local/edwiserreports/lms_custom_api_get_subjectManage.php?semesterId=' + semesterId, {
            method: 'POST', // or 'PUT'
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify([]),
        })
            .then((response) => response.json())
            .then((dataRes) => {
                if (dataRes.message == 'success') {
                    let subjectManageHTML = ''
                    let i = 0
                    dataRes.data.forEach(subjectManage => {
                        subjectManageHTML += `<option value="${subjectManage.id}" ${i === 0 ? 'selected' : ''}>${subjectManage.name}</option>`
                        i++
                    })
                    if (i === 0) {
                        subjectManageHTML = `<option value="0"}>Không có dữ liệu</option>`
                    }
                    subjectManageSelector.innerHTML = subjectManageHTML
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            })
    }

    function fetchDataSubject(domain, subjectSelector, subjectManageId) {
        if (subjectManageId != 0) {
            fetch(domain + '/local/edwiserreports/lms_custom_api_get_subject.php?subjectManageId=' + subjectManageId, {
                method: 'POST', // or 'PUT'
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify([]),
            })
                .then((response) => response.json())
                .then((dataRes) => {
                    if (dataRes.message == 'success') {
                        let subjectHTML = ''
                        let i = 0
                        dataRes.data.forEach(subject => {
                            subjectHTML += `<option value="${subject.id}" ${i === 0 ? 'selected' : ''}>${subject.name}</option>`
                            i++
                        })

                        if (i === 0) {
                            subjectHTML = `<option value="0"}>Không có dữ liệu</option>`
                        }

                        subjectSelector.innerHTML = subjectHTML
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                })
        } else {
            subjectSelector.innerHTML = `<option value="0"}>Không có dữ liệu</option>`
        }
    }

    const domain = window.location.origin;
    const blocks = document.querySelectorAll('.edwiserReport-block')
    blocks.forEach(block => {
        const firstChild = block.firstElementChild
        if (firstChild.nodeName == 'DIV' && firstChild.id.includes('customreportsblock')) {
            const awaitDatatableLoaded = setInterval(() => {
                const divCustomWrapper = firstChild.querySelector('.panel .panel-body .dataTables_wrapper')
                if (divCustomWrapper != null) {
                    const parentDivCustom = divCustomWrapper.firstElementChild
                    const divCustom = parentDivCustom.firstElementChild
                    const divNextDivParentCustom = divCustom.nextSibling
                    const inputSearchDefault = divNextDivParentCustom.querySelector('input')
                    const cssDivCustom = `display: flex;
                                            align-items: center;
                                            justify-content: space-around;`

                    divCustom.style.cssText += cssDivCustom

                    const yearSelector = document.createElement('select')
                    yearSelector.setAttribute('class', 'form-control')
                    yearSelector.style.cssText += `width: 45%`

                    const semesterSelector = document.createElement('select')
                    semesterSelector.setAttribute('class', 'form-control')
                    semesterSelector.style.cssText += `width: 45%`

                    divCustom.appendChild(yearSelector)
                    divCustom.appendChild(semesterSelector)

                    const inputSearchNew = document.createElement('input')
                    inputSearchNew.setAttribute('type', 'text')
                    inputSearchNew.setAttribute('class', 'form-control')
                    inputSearchNew.setAttribute('placeholder', 'Tìm kiếm theo tên')
                    inputSearchNew.style.cssText += `width: 45%`
                    divNextDivParentCustom.appendChild(inputSearchNew)
                    inputSearchDefault.style.cssText += `visibility: hidden;`

                    fetchGetDataYear(domain, yearSelector)

                    yearSelector.addEventListener('change', handleChangeYearSelector)
                    let yearId = 0
                    function handleChangeYearSelector() {
                        const awaitFetchYear = setInterval(function () {
                            if (yearSelector.value) {
                                yearId = Number(yearSelector.value)
                                fetchDataSemester(domain, semesterSelector, yearId)
                                semesterSelector.dispatchEvent(new Event('change', { bubbles: true }))
                                clearInterval(awaitFetchYear)
                            }
                        }, 200)
                    }

                    function triggerEventInputDefault() {
                        const awaitFetchDataYear = setInterval(function () {
                            if (yearSelector.value) {
                                let yearString = yearSelector.value
                                let semesterString = semesterSelector.value
                                let searchString = inputSearchNew.value
    
                                inputSearchDefault.value = yearString + ' ' + semesterString + ' ' + searchString
                                inputSearchDefault.dispatchEvent(new Event('input', { bubbles: true }))

                                clearInterval(awaitFetchDataYear)
                            }
                        }, 200)
                    }
                    semesterSelector.addEventListener('change', triggerEventInputDefault)
                    inputSearchNew.addEventListener('input', triggerEventInputDefault)
                    handleChangeYearSelector()


                    clearInterval(awaitDatatableLoaded)
                }
            }, 500)
        }

        if (firstChild.nodeName == 'DIV' && firstChild.id == 'courseprogressblock') {
            const awaitCourseProgressLoaded = setInterval(function () {
                const panelBody = firstChild.querySelector('.panel-body')
                const divLoader = panelBody.querySelector('.loader.w-full.text-center')

                if (divLoader.style.display === 'none') {
                    const selectDefault = panelBody.querySelector('select#wdm-courseprogress-select')

                    panelBody.childNodes.forEach(function (element) {
                        if (element.nodeName == 'SPAN') {
                            element.style.display = 'none'
                        }
                    })
                    // create element div wrapper
                    const divCustomWrapper = document.createElement('div')
                    panelBody.insertBefore(divCustomWrapper, panelBody.firstChild)

                    // create year selector into div wrapper
                    const yearSelector = document.createElement('select')
                    yearSelector.setAttribute('class', 'form-control')
                    yearSelector.style.cssText += `margin-bottom: 16px;`
                    divCustomWrapper.appendChild(yearSelector)

                    // create semester selector into div wrapper
                    const semesterSelector = document.createElement('select')
                    semesterSelector.setAttribute('class', 'form-control')
                    semesterSelector.style.cssText += `margin-bottom: 16px;`
                    divCustomWrapper.appendChild(semesterSelector)

                    // create subject manage selector into div wrapper
                    const subjectManageSelector = document.createElement('select')
                    subjectManageSelector.setAttribute('class', 'form-control')
                    subjectManageSelector.style.cssText += `margin-bottom: 16px;`
                    divCustomWrapper.appendChild(subjectManageSelector)

                    // create subject selector into div wrapper
                    const subjectSelector = document.createElement('select')
                    subjectSelector.setAttribute('class', 'form-control')
                    subjectSelector.style.cssText += `margin-bottom: 16px;`
                    divCustomWrapper.appendChild(subjectSelector)

                    fetchGetDataYear(domain, yearSelector)

                    function handleChangeYear() {
                        const awaitFetchYear = setInterval(function () {
                            if (yearSelector.value) {
                                fetchDataSemester(domain, semesterSelector, yearSelector.value)
                                semesterSelector.dispatchEvent(new Event('change', { bubbles: true }))
                                clearInterval(awaitFetchYear)
                            }
                        }, 200)
                    }

                    yearSelector.addEventListener('change', handleChangeYear)

                    semesterSelector.addEventListener('change', function () {
                        const awaitFetchSemester = setInterval(function () {
                            if (semesterSelector.value) {
                                fetchDataSubjectManage(domain, subjectManageSelector, semesterSelector.value)
                                subjectManageSelector.dispatchEvent(new Event('change', { bubbles: true }))
                                clearInterval(awaitFetchSemester)
                            }
                        }, 200)
                    })

                    subjectManageSelector.addEventListener('change', function () {
                        const awaitFetchSubjectManage = setInterval(function () {
                            if (subjectManageSelector.value) {
                                fetchDataSubject(domain, subjectSelector, subjectManageSelector.value)
                                subjectSelector.dispatchEvent(new Event('change', { bubbles: true }))
                                clearInterval(awaitFetchSubjectManage)
                            }
                        }, 200)
                    })

                    subjectSelector.addEventListener('change', function () {
                        const awaitFetchSubject = setInterval(function () {
                            if (subjectSelector.value) {
                                selectDefault.value = subjectSelector.value
                                selectDefault.dispatchEvent(new Event('change', { bubbles: true }))
                                clearInterval(awaitFetchSubject)
                            }
                        }, 200)
                    })
                    yearSelector.dispatchEvent(new Event('change'))
                    clearInterval(awaitCourseProgressLoaded)
                }

            }, 500)
        }

        if (firstChild.nodeName == 'DIV' && firstChild.id == 'activecoursesblock') {
            const awaitDatatableLoaded = setInterval(() => {
                const divCustomWrapper = firstChild.querySelector('.panel .panel-body .dataTables_wrapper')
                if (divCustomWrapper != null) {
                    const inputDefault = divCustomWrapper.querySelector('.dataTables_filter input')
                    inputDefault.style.cssText += 'display: none;'

                    const divCustom = document.createElement('div')
                    divCustom.setAttribute('class', 'row')
                    divCustomWrapper.insertBefore(divCustom, divCustomWrapper.firstChild)

                    // create year selector into div wrapper
                    const yearSelector = document.createElement('select')
                    yearSelector.setAttribute('class', 'form-control')
                    yearSelector.style.cssText += `margin-bottom: 16px;`
                    divCustom.appendChild(yearSelector)

                    // create semester selector into div wrapper
                    const semesterSelector = document.createElement('select')
                    semesterSelector.setAttribute('class', 'form-control')
                    semesterSelector.style.cssText += `margin-bottom: 16px;`
                    divCustom.appendChild(semesterSelector)

                    // create search input into div wrapper
                    const inputSearchNew = document.createElement('input')
                    inputSearchNew.setAttribute('class', 'form-control')
                    inputSearchNew.setAttribute('placeholder', 'Tìm kiếm')
                    divCustom.appendChild(inputSearchNew)

                    fetchGetDataYear(domain, yearSelector)

                    function handleYearSelect() {
                        const awaitYearSelectLoaded = setInterval(function () {
                            if (yearSelector.value) {
                                fetchDataSemester(domain, semesterSelector, yearSelector.value)
                                semesterSelector.dispatchEvent(new Event('change'))
                                clearInterval(awaitYearSelectLoaded)
                            }
                        }, 200)
                    }

                    yearSelector.addEventListener('change', handleYearSelect)

                    semesterSelector.addEventListener('change', function () {
                        const awaitSemesterLoaded = setInterval(function () {
                            if (semesterSelector.value) {
                                handleChangeValue()
                                clearInterval(awaitSemesterLoaded)
                            }
                        }, 200)
                    })

                    inputSearchNew.addEventListener('input', handleChangeValue)

                    function handleChangeValue() {
                        let yearValue = yearSelector.value ?? ''
                        let semesterValue = semesterSelector.value ?? ''
                        let searchValue = inputSearchNew.value ?? ''

                        inputDefault.value = `${yearValue} ${semesterValue} ${searchValue}`
                        inputDefault.dispatchEvent(new Event('input', { bubbles: true }))
                    }

                    // handleYearSelect()
                    yearSelector.dispatchEvent(new Event('change', { bubbles: true }))

                    clearInterval(awaitDatatableLoaded)
                }
            }, 500)
        }
    })
</script>