define("mod_learningmap/learningmap",["exports","core/notification","core/templates","mod_learningmap/placestore"],(function(_exports,_notification,_templates,_placestore){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),_placestore=_interopRequireDefault(_placestore);_exports.init=function(){var offset,upd1,upd2;_templates.default.prefetchTemplates(["mod_learningmap/cssskeleton"]);var selectedElement=null,firstPlace=null,secondPlace=null,lastTarget=null,elementForActivitySelector=null,mapdiv=document.getElementById("learningmap-editor-map"),code=document.getElementById("id_introeditor_text"),colorChooserPlace=document.getElementById("learningmap-color-place"),colorChooserVisited=document.getElementById("learningmap-color-visited"),colorChooserPath=document.getElementById("learningmap-color-path"),activitySetting=document.getElementById("learningmap-activity-setting"),activitySelector=document.getElementById("learningmap-activity-selector"),activityStarting=document.getElementById("learningmap-activity-starting"),activityTarget=document.getElementById("learningmap-activity-target"),advancedSettingsIcon=document.getElementById("learningmap-advanced-settings-icon"),treeView=document.querySelector(".fp-viewbar .fp-vb-tree");treeView&&treeView.setAttribute("style","display: none;");var iconView=document.querySelector(".fp-viewbar .fp-vb-icons");iconView&&setTimeout((function(){iconView.dispatchEvent(new Event("click"))}),1e3),activitySelector&&(activitySelector.addEventListener("change",(function(){_placestore.default.setActivityId(elementForActivitySelector,activitySelector.value),activitySelector.value?document.getElementById(elementForActivitySelector).classList.remove("learningmap-emptyplace"):document.getElementById(elementForActivitySelector).classList.add("learningmap-emptyplace"),updateActivities(),updateCode()})),activityStarting.addEventListener("change",(function(){activityStarting.checked?_placestore.default.addStartingPlace(elementForActivitySelector):_placestore.default.removeStartingPlace(elementForActivitySelector),updateCode()})),activityTarget.addEventListener("change",(function(){activityTarget.checked?(_placestore.default.addTargetPlace(elementForActivitySelector),document.getElementById(elementForActivitySelector).classList.add("learningmap-targetplace")):(_placestore.default.removeTargetPlace(elementForActivitySelector),document.getElementById(elementForActivitySelector).classList.remove("learningmap-targetplace")),updateCode()})));var background,placestoreInput=document.getElementsByName("placestore")[0];if(placestoreInput&&_placestore.default.loadJSON(placestoreInput.value),updateActivities(),advancedSettingsIcon){var advancedSettings=document.getElementById("learningmap-advanced-settings");advancedSettingsIcon.addEventListener("click",(function(){advancedSettings.removeAttribute("hidden")}));var advancedSettingsClose=document.getElementById("learningmap-advanced-settings-close");advancedSettingsClose&&advancedSettingsClose.addEventListener("click",(function(){advancedSettings.setAttribute("hidden","")}));var hidepaths=document.getElementById("learningmap-hidepaths");hidepaths&&(_placestore.default.getHidePaths()&&(hidepaths.checked=!0),hidepaths.addEventListener("change",(function(){hidepaths.checked?_placestore.default.setHidePaths(!0):_placestore.default.setHidePaths(!1),updateCSS()})));var usecheckmark=document.getElementById("learningmap-usecheckmark");usecheckmark&&(_placestore.default.getUseCheckmark()&&(usecheckmark.checked=!0),usecheckmark.addEventListener("change",(function(){usecheckmark.checked?_placestore.default.setUseCheckmark(!0):_placestore.default.setUseCheckmark(!1),updateCSS()})))}colorChooserPath&&(colorChooserPath.addEventListener("change",(function(){_placestore.default.setColor("stroke",colorChooserPath.value),updateCSS()})),colorChooserPath.value=_placestore.default.getColor("stroke")),colorChooserPlace&&(colorChooserPlace.addEventListener("change",(function(){_placestore.default.setColor("place",colorChooserPlace.value),updateCSS()})),colorChooserPlace.value=_placestore.default.getColor("place")),colorChooserVisited&&(colorChooserVisited.addEventListener("change",(function(){_placestore.default.setColor("visited",colorChooserVisited.value),updateCSS()})),colorChooserVisited.value=_placestore.default.getColor("visited")),code&&mapdiv&&(mapdiv.innerHTML=code.value),refreshBackgroundImage(),(background=document.getElementById("learningmap-background-image"))&&background.addEventListener("load",(function(){background.removeAttribute("height");var height=parseInt(background.getBBox().height),width=background.getBBox().width;_placestore.default.setBackgroundDimensions(width,height),svg.setAttribute("viewBox","0 0 "+_placestore.default.width+" "+_placestore.default.height),background.setAttribute("width",width),background.setAttribute("height",height),updateCode()})),updateCode();var svg=document.getElementById("learningmap-svgmap-"+_placestore.default.getMapid());function hideContextMenu(){var e=document.getElementById(elementForActivitySelector);e&&e.classList.remove("learningmap-selected-activity-selector"),activitySetting.setAttribute("hidden","")}!function(el){el&&(el.addEventListener("mousedown",startDrag),el.addEventListener("mousemove",drag),el.addEventListener("mouseup",endDrag),el.addEventListener("mouseleave",endDrag),el.addEventListener("touchstart",startDrag),el.addEventListener("touchmove",drag),el.addEventListener("touchend",endDrag),el.addEventListener("touchleave",endDrag),el.addEventListener("touchcancel",endDrag));function getMousePosition(evt){var CTM=el.getScreenCTM();return evt.touches&&(evt=evt.touches[0]),{x:(evt.clientX-CTM.e)/CTM.a,y:(evt.clientY-CTM.f)/CTM.d}}function startDrag(evt){evt.preventDefault(),evt.target.classList.contains("learningmap-draggable")&&(selectedElement=evt.target,(offset=getMousePosition(evt)).x-=parseInt(selectedElement.getAttributeNS(null,"cx")),offset.y-=parseInt(selectedElement.getAttributeNS(null,"cy")),upd1=_placestore.default.getPathsWithFid(selectedElement.id),upd2=_placestore.default.getPathsWithSid(selectedElement.id))}function drag(evt){if(evt.preventDefault(),selectedElement){var coord=getMousePosition(evt),cx=coord.x-offset.x,cy=coord.y-offset.y;selectedElement.setAttributeNS(null,"cx",cx),selectedElement.setAttributeNS(null,"cy",cy),upd1.forEach((function(p){var d=document.getElementById(p.id);if(null!==d)if("path"==d.nodeName){var pathDeclaration=d.getAttribute("d"),newPathDeclaration="M "+cx+" "+cy+" L"+pathDeclaration.split("L")[1];d.setAttribute("d",newPathDeclaration)}else d.setAttribute("x1",cx),d.setAttribute("y1",cy)})),upd2.forEach((function(p){var d=document.getElementById(p.id);if(null!==d)if("path"==d.nodeName){var newPathDeclaration=d.getAttribute("d").split("L")[0]+"L "+cx+" "+cy;d.setAttribute("d",newPathDeclaration)}else d.setAttribute("x2",cx),d.setAttribute("y2",cy)}))}}function endDrag(evt){evt.preventDefault(),selectedElement=null,unselectAll(),updateCode()}}(svg),updateCSS(),mapdiv&&(mapdiv.addEventListener("dblclick",(function(event){hideContextMenu(),unselectAll(),event.target.classList.contains("learningmap-mapcontainer")||event.target.classList.contains("learningmap-background-image")?function(event){var placesgroup=document.getElementById("placesGroup"),placeId="p"+_placestore.default.getId(),linkId="a"+_placestore.default.getId(),CTM=event.target.getScreenCTM();event.touches&&(event=event.touches[0]);var cx=(event.clientX-CTM.e)/CTM.a,cy=(event.clientY-CTM.f)/CTM.d;placesgroup.appendChild(function(child,id){var title=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,link=document.createElementNS("http://www.w3.org/2000/svg","a");link.setAttribute("id",id),link.setAttribute("xlink:href",""),link.appendChild(child),null===title||link.appendChild(title);return link}(function(x,y,r,classes,id){var circle=document.createElementNS("http://www.w3.org/2000/svg","circle");return circle.setAttribute("class",classes),circle.setAttribute("id",id),circle.setAttribute("cx",x),circle.setAttribute("cy",y),circle.setAttribute("r",r),circle}(cx,cy,10,"learningmap-place learningmap-draggable learningmap-emptyplace",placeId),linkId,function(id){var title=document.createElementNS("http://www.w3.org/2000/svg","title");return title.setAttribute("id",id),title}("title"+placeId))),_placestore.default.addPlace(placeId,linkId)}(event):event.target.classList.contains("learningmap-place")?lastTarget==event.target.id?(lastTarget=null,clickHandler(event)):function(event){var place=document.getElementById(event.target.id),parent=place.parentNode;id=event.target.id,_placestore.default.getTouchingPaths(id).forEach((function(e){removePath(e.id)})),_placestore.default.removePlace(event.target.id),parent.removeChild(place),parent.parentNode.removeChild(parent),updateCode();var id}(event):event.target.classList.contains("learningmap-path")&&removePath(event.target.id);updateCode()})),mapdiv.addEventListener("click",clickHandler),mapdiv.addEventListener("contextmenu",(function(e){e.preventDefault(),function(e){if(unselectAll(),activitySetting)if(e.target.classList.contains("learningmap-place")){e.target.classList.add("learningmap-selected-activity-selector");var activityId=_placestore.default.getActivityId(e.target.id),cy=e.offsetY,cx=e.offsetX,vertical="top",height=svg.getBoundingClientRect().height,width=svg.getBoundingClientRect().width;cy>height/2&&(vertical="bottom",cy=height-cy);var horizontal="left";cx>width/2&&(horizontal="right",cx=width-cx),activitySetting.setAttribute("style",vertical+": "+cy+"px; "+horizontal+": "+cx+"px;"),activitySetting.removeAttribute("hidden"),document.getElementById("learningmap-activity-selector").value=activityId,_placestore.default.isStartingPlace(e.target.id)?document.getElementById("learningmap-activity-starting").checked=!0:document.getElementById("learningmap-activity-starting").checked=!1,_placestore.default.isTargetPlace(e.target.id)?document.getElementById("learningmap-activity-target").checked=!0:document.getElementById("learningmap-activity-target").checked=!1,elementForActivitySelector=e.target.id}else hideContextMenu()}(e)}),!1));var backgroundfileNode=document.getElementById("id_introeditor_itemid_fieldset");backgroundfileNode&&new MutationObserver(refreshBackgroundImage).observe(backgroundfileNode,{attributes:!0,childList:!0,subtree:!0});function updateCode(){code&&mapdiv&&(code.innerHTML=mapdiv.innerHTML),placestoreInput&&(document.getElementsByName("placestore")[0].value=JSON.stringify(_placestore.default.getPlacestore()))}function clickHandler(event){if(event.preventDefault(),hideContextMenu(),event.target.classList.contains("learningmap-place")&&null===selectedElement)if(null===firstPlace)firstPlace=event.target.id,document.getElementById(firstPlace).classList.add("learningmap-selected");else{secondPlace=event.target.id;var fid=parseInt(firstPlace.replace("p","")),sid=parseInt(secondPlace.replace("p",""));if(sid==fid)return;if(sid<fid){var z=sid;sid=fid,fid=z}!function(fid,sid){var pid="p"+fid+"_"+sid;if(null===document.getElementById(pid)){var pathsgroup=document.getElementById("pathsGroup"),first=document.getElementById("p"+fid),second=document.getElementById("p"+sid);pathsgroup&&first&&second&&(pathsgroup.appendChild(function(x1,y1,x2,y2,classes,id){var path=document.createElementNS("http://www.w3.org/2000/svg","path");return path.setAttribute("class",classes),path.setAttribute("id",id),path.setAttribute("d","M "+x1+" "+y1+" L "+x2+" "+y2),path}(first.cx.baseVal.value,first.cy.baseVal.value,second.cx.baseVal.value,second.cy.baseVal.value,"learningmap-path",pid)),_placestore.default.addPath(pid,"p"+fid,"p"+sid))}}(fid,sid);var first=document.getElementById(firstPlace);first&&first.classList.remove("learningmap-selected"),firstPlace=null,lastTarget=secondPlace,secondPlace=null}else unselectAll(),firstPlace=null}function unselectAll(){Array.from(document.getElementsByClassName("learningmap-selected")).forEach((function(e){e.classList.remove("learningmap-selected")})),Array.from(document.getElementsByClassName("learningmap-selected-activity-selector")).forEach((function(e){e.classList.remove("learningmap-selected-activity-selector")}))}function removePath(id){var path=document.getElementById(id);null!==path&&(path.parentNode.removeChild(path),_placestore.default.removePath(id))}function refreshBackgroundImage(){var previewimage=document.getElementsByClassName("realpreview");previewimage.length>0&&document.getElementById("learningmap-background-image").setAttribute("xlink:href",previewimage[0].getAttribute("src").split("?")[0])}function updateCSS(){_templates.default.renderForPromise("mod_learningmap/cssskeleton",_placestore.default.getPlacestore()).then((function(_ref){var html=_ref.html,js=_ref.js;return _templates.default.replaceNode("#learningmap-svgstyle",html,js),updateCode(),!0})).catch((function(ex){return(0,_notification.exception)(ex)}))}function updateActivities(){var activities=_placestore.default.getAllActivities();Array.from(activitySelector.getElementsByTagName("option")).forEach((function(n){activities.includes(n.value)?n.classList.add("learningmap-used-activity"):n.classList.remove("learningmap-used-activity")}))}}}));

//# sourceMappingURL=learningmap.min.js.map