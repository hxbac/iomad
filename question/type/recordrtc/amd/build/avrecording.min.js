define ("qtype_recordrtc/avrecording",["exports","core/log","core/modal_factory","core/notification"],function(a,b,c,d){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=function(a,b){M.util.js_pending("init-"+a);new i(a,b);M.util.js_complete("init-"+a)};b=e(b);c=e(c);d=e(d);var j="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function e(a){return a&&a.__esModule?a:{default:a}}function f(){if(!(navigator.mediaDevices&&window.MediaRecorder)){return"nowebrtc"}if(!("https:"===location.protocol||-1!==location.host.indexOf("localhost"))){return"nothttps"}return"ok"}var k=("function"==typeof j.define&&j.define.amd?new Promise(function(a,b){j.require([M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/worker.umd.js"],a,b)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&j.require&&"component"===j.require.loader?Promise.resolve(require((M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/worker.umd.js"))):Promise.resolve(j[M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/worker.umd.js"])).then(function(){return"function"==typeof j.define&&j.define.amd?new Promise(function(a,b){j.require([M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/index.umd.js"],a,b)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&j.require&&"component"===j.require.loader?Promise.resolve(require((M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/index.umd.js"))):Promise.resolve(j[M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/index.umd.js"])}).then(function(a){var c=a.Mp3MediaRecorder,d=URL.createObjectURL(new Blob(["importScripts('"+M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/worker.umd.js');","mp3EncoderWorker.initMp3MediaEncoder({vmsgWasmUrl: '"+M.cfg.wwwroot+"/question/type/recordrtc/js/vmsg@0.4.0/vmsg.wasm'});"],{type:"application/javascript"}));return function(a,e,f,g,h,i,j,k,l){var I=this,J=null,K=null,L=[],N=0,O=0,P=0;h.addEventListener("click",function(a){a.preventDefault();switch(h.dataset.state){case"new":case"recorded":m();break;case"starting":o();break;case"recording":q();break;}});this.uploadMediaToServer=function(){C("uploadpreparing");var a=new XMLHttpRequest;a.open("GET",f.src);a.responseType="blob";a.addEventListener("load",x);a.send()};function m(){if(a.hidePlayerDuringRecording){f.parentElement.classList.add("hide");g.classList.remove("hide");g.textContent="\xA0"}else{f.parentElement.classList.remove("hide");g.classList.add("hide")}h.classList.remove("btn-outline-danger");h.classList.add("btn-danger");G();L=[];N=0;navigator.mediaDevices.getUserMedia(a.mediaConstraints).then(n).catch(s)}function n(b){J=b;f.srcObject=b;f.muted=!0;if(a.hidePlayerDuringRecording){o()}else{f.play();f.controls=!1;h.dataset.state="starting";C("startrecording")}h.disabled=!1;h.focus()}function o(){if("audio"===a.name){K=new c(J,{worker:new Worker(d)})}else{K=new MediaRecorder(J,E())}K.ondataavailable=p;K.onstop=r;K.start(1e3);h.dataset.state="recording";t()}function p(a){N+=a.data.size;if(0<=k.maxUploadSize&&N>=k.maxUploadSize){if(!localStorage.getItem("alerted")){localStorage.setItem("alerted","true");q();j.showAlert("nearingmaxsize")}else{localStorage.removeItem("alerted")}}L.push(a.data);if("undefined"!=typeof M.core_formchangechecker&&!window.location.pathname.endsWith("/question/preview.php")){M.core_formchangechecker.set_form_changed()}}function q(){h.disabled=!0;u();h.classList.remove("btn-danger");h.classList.add("btn-outline-danger");K.stop();for(var a=J.getTracks(),b=0;b<a.length;b++){a[b].stop()}}function r(){if("new"===h.dataset.state){return}var a=new Blob(L,{type:K.mimeType});f.srcObject=null;f.src=URL.createObjectURL(a);f.muted=!1;f.controls=!0;f.parentElement.classList.remove("hide");g.classList.add("hide");f.focus();h.disabled=!0;h.classList.remove("btn-danger");h.classList.add("btn-outline-danger");h.dataset.state="recorded";if(0<L.length){j.notifyRecordingComplete(I)}}function s(a){b.default.debug("Audio/video question: error received");b.default.debug(a);D("recordingfailed");C("recordagain");h.classList.remove("btn-danger");h.classList.add("btn-outline-danger");h.dataset.state="new";if(K){K.stop()}var c="gum"+a.name.replace("Error","").toLowerCase();j.showAlert(c);F()}function t(){O=e;v();P=setInterval(v,1e3)}function u(){if(0!==P){clearInterval(P);P=0}}function v(){var a=O%60,b=Math.round((O-a)/60);C("recordinginprogress",w(b)+":"+w(a));if(-1===O){q()}O-=1}function w(a){var b=a+"";if(2>b.length){return"0"+b}else{return b}}function x(a){var b=a.target;if(200!==b.status){return}var c=b.response,d=new FormData;d.append("repo_upload_file",c,i);d.append("sesskey",M.cfg.sesskey);d.append("repo_id",k.uploadRepositoryId);d.append("itemid",k.draftItemId);d.append("savepath","/");d.append("ctx_id",k.contextId);d.append("overwrite",1);var e=new XMLHttpRequest;e.addEventListener("readystatechange",y);e.upload.addEventListener("progress",z);e.addEventListener("error",A);e.addEventListener("abort",B);e.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload");e.send(d)}function y(a){var b=a.target;if(4===b.readyState&&200===b.status){C("recordagain");F()}else if(404===b.status){D("uploadfailed404");F()}}function z(a){C("uploadprogress",Math.round(100*(a.loaded/a.total))+"%")}function A(){D("uploadfailed");F()}function B(){D("uploadaborted");F()}function C(b,c){h.innerText=M.util.get_string(b,"qtype_recordrtc",c)}function D(b,c){g.textContent=M.util.get_string(b,"qtype_recordrtc",c);f.parentElement.classList.add("hide");g.classList.remove("hide")}function E(){var b={};if("audio"===a.name){b.audioBitsPerSecond=parseInt(k.audioBitRate,10)}else if("video"===a.name){b.videoBitsPerSecond=parseInt(k.videoBitRate,10);b.videoWidth=parseInt(k.videoWidth,10);b.videoHeight=parseInt(k.videoHeight,10);for(var c=0;c<a.mimeTypes.length;c++){if(MediaRecorder.isTypeSupported(a.mimeTypes[c])){b.mimeType=a.mimeTypes[c];break}}}return b}function F(){H(!0);j.notifyButtonStatesChanged()}function G(){H(!1)}function H(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1;l.querySelectorAll("button, input[type=submit], input[type=button]").forEach(function(b){b.disabled=!a})}}});function g(){this.name="audio";this.hidePlayerDuringRecording=!0;this.mediaConstraints={audio:!0};this.mimeTypes=["audio/mpeg"]}function h(a,b){this.name="video";this.hidePlayerDuringRecording=!1;this.mediaConstraints={audio:!0,video:{width:{ideal:a},height:{ideal:b}}};this.mimeTypes=["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]}function i(a,b){var j=document.getElementById(a),l=f();if("nothttps"===l){j.querySelector(".https-warning").classList.remove("hide");return}else if("nowebrtc"===l){j.querySelector(".no-webrtc-warning").classList.remove("hide");return}this.showAlert=i;this.notifyRecordingComplete=function(a){a.uploadMediaToServer()};this.notifyButtonStatesChanged=e;var m=this;j.querySelectorAll(".audio-widget, .video-widget").forEach(function(a){var c=a.dataset.mediaType,e=a.dataset.maxRecordingDuration,f=a.querySelector(".record-button button"),i=a.querySelector(".media-player "+c),l=a.querySelector(".no-recording-placeholder"),n=a.dataset.recordingFilename,o;if("audio"===c){o=new g}else{o=new h(b.videoWidth,b.videoHeight)}k.then(function(a){new a(o,e,i,l,f,n,m,b,j);return"Why should I have to return anything here?"}).catch(d.default.exception)});e();function e(){var a=!1;j.querySelectorAll(".audio-widget, .video-widget").forEach(function(b){if("recorded"===b.querySelector(".record-button button").dataset.state){a=!0}});var b=j.querySelector("input.submit[type=submit]");if(b){b.disabled=!a}}function i(a){return c.default.create({type:c.default.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){a.show();return a})}}});
//# sourceMappingURL=avrecording.min.js.map
